<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - eigo.email</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #7c3aed, #6ee7b7); color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; }
        .header h1 { font-size: 32px; margin-bottom: 10px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .stat-card h3 { font-size: 14px; color: #666; margin-bottom: 8px; text-transform: uppercase; }
        .stat-card .value { font-size: 36px; font-weight: 700; color: #7c3aed; }
        .section { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .section h2 { font-size: 24px; margin-bottom: 20px; color: #333; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        th { background: #f9f9f9; font-weight: 600; color: #666; font-size: 12px; text-transform: uppercase; }
        tr:hover { background: #f9f9f9; }
        .status-active { color: #10b981; font-weight: 600; }
        .status-expired { color: #ef4444; font-weight: 600; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-primary { background: #7c3aed; color: white; }
        .btn:hover { opacity: 0.9; }
        .login-box { max-width: 400px; margin: 100px auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .login-box h1 { margin-bottom: 30px; color: #333; }
        .login-box input { width: 100%; padding: 12px; margin-bottom: 16px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }
        .login-box button { width: 100%; padding: 12px; background: linear-gradient(135deg, #7c3aed, #6ee7b7); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .error { color: #ef4444; margin-bottom: 16px; padding: 12px; background: #fee; border-radius: 6px; }
        .logout-btn { float: right; padding: 10px 20px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 6px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-box">
        <h1>üîê Admin Login</h1>
        <div id="loginError" class="error" style="display: none;"></div>
        <input type="text" id="username" placeholder="Username" autocomplete="username">
        <input type="password" id="password" placeholder="Password" autocomplete="current-password">
        <button onclick="login()">Login</button>
    </div>

    <div id="adminPanel" style="display: none;">
        <div class="container">
            <div class="header">
                <button class="logout-btn" onclick="logout()">Logout</button>
                <h1>üìä Admin Dashboard</h1>
                <p>eigo.email subscription management</p>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <h3>Total Subscribers</h3>
                    <div class="value" id="totalSubs">-</div>
                </div>
                <div class="stat-card">
                    <h3>Active Subscriptions</h3>
                    <div class="value" id="activeSubs">-</div>
                </div>
                <div class="stat-card">
                    <h3>Expired</h3>
                    <div class="value" id="expiredSubs">-</div>
                </div>
                <div class="stat-card">
                    <h3>Total Revenue (USDC)</h3>
                    <div class="value" id="totalRevenue">-</div>
                </div>
            </div>

            <div class="section">
                <h2>üìã Subscribers</h2>
                <table id="subscribersTable">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Language</th>
                            <th>Level</th>
                            <th>Status</th>
                            <th>Expires</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="subscribersBody"></tbody>
                </table>
            </div>

            <div class="section">
                <h2>üí∞ Recent Orders</h2>
                <button class="btn btn-danger" onclick="cleanupPending()" style="margin-bottom: 16px;">üßπ Cleanup Old Pending Orders (24h+)</button>
                <table id="ordersTable">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Plan</th>
                            <th>Amount (USDC)</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Reference</th>
                        </tr>
                    </thead>
                    <tbody id="ordersBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let authToken = localStorage.getItem('adminToken');

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');

            try {
                const res = await fetch('/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                
                if (res.ok && data.token) {
                    authToken = data.token;
                    localStorage.setItem('adminToken', authToken);
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('adminPanel').style.display = 'block';
                    loadDashboard();
                } else {
                    errorDiv.textContent = data.error || 'Invalid credentials';
                    errorDiv.style.display = 'block';
                }
            } catch (e) {
                errorDiv.textContent = 'Login failed: ' + e.message;
                errorDiv.style.display = 'block';
            }
        }

        function logout() {
            localStorage.removeItem('adminToken');
            authToken = null;
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
        }

        async function loadDashboard() {
            try {
                const res = await fetch('/admin/dashboard', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!res.ok) {
                    logout();
                    return;
                }

                const data = await res.json();
                
                // Update stats
                document.getElementById('totalSubs').textContent = data.stats.total;
                document.getElementById('activeSubs').textContent = data.stats.active;
                document.getElementById('expiredSubs').textContent = data.stats.expired;
                document.getElementById('totalRevenue').textContent = data.stats.revenue;

                // Render subscribers
                const subBody = document.getElementById('subscribersBody');
                subBody.innerHTML = data.subscribers.map(s => {
                    const isActive = !s.expiresAt || s.expiresAt > Date.now();
                    const expires = s.expiresAt ? new Date(s.expiresAt).toLocaleDateString() : 'Never';
                    const created = new Date(s.createdAt).toLocaleDateString();
                    return `
                        <tr>
                            <td>${s.email}</td>
                            <td>${s.language || 'english'}</td>
                            <td>${s.level || 'B1'}</td>
                            <td class="${isActive ? 'status-active' : 'status-expired'}">${isActive ? 'Active' : 'Expired'}</td>
                            <td>${expires}</td>
                            <td>${created}</td>
                            <td>
                                ${isActive ? 
                                    `<button class="btn btn-danger" onclick="cancelSub('${s.email}')">Cancel</button>` : 
                                    `<button class="btn btn-success" onclick="extendSub('${s.email}')">Extend</button>`
                                }
                            </td>
                        </tr>
                    `;
                }).join('');

                // Render orders
                const ordBody = document.getElementById('ordersBody');
                ordBody.innerHTML = data.orders.slice(0, 20).map(o => {
                    const date = new Date(o.createdAt).toLocaleString();
                    return `
                        <tr>
                            <td>${o.email}</td>
                            <td>${o.plan}</td>
                            <td>${o.amount}</td>
                            <td>${o.status}</td>
                            <td>${date}</td>
                            <td style="font-family: monospace; font-size: 12px;">${o.reference.substring(0, 20)}...</td>
                        </tr>
                    `;
                }).join('');
            } catch (e) {
                console.error('Failed to load dashboard:', e);
            }
        }

        async function cancelSub(email) {
            if (!confirm(`Cancel subscription for ${email}?`)) return;
            
            try {
                const res = await fetch('/admin/cancel-subscription', {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email })
                });
                
                if (res.ok) {
                    alert('Subscription cancelled');
                    loadDashboard();
                } else {
                    alert('Failed to cancel subscription');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function extendSub(email) {
            const days = prompt(`Extend subscription for ${email} by how many days?`, '30');
            if (!days) return;
            
            try {
                const res = await fetch('/admin/extend-subscription', {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, days: parseInt(days) })
                });
                
                if (res.ok) {
                    alert('Subscription extended');
                    loadDashboard();
                } else {
                    alert('Failed to extend subscription');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // Check if already logged in
        if (authToken) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            loadDashboard();
        }

        async function cleanupPending() {
            if (!confirm('This will delete all pending orders older than 24 hours. Continue?')) return;
            
            try {
                const res = await fetch('/admin/cleanup-pending', {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await res.json();
                if (res.ok) {
                    alert(`Cleaned up ${data.deleted} old pending orders`);
                    loadDashboard();
                } else {
                    alert('Failed to cleanup: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // Enter key to login
        document.getElementById('password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') login();
        });
    </script>
</body>
</html>

